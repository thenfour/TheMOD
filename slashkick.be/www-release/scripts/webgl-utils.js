/*
 * Copyright 2012, Gregg Tavares.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 * notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following disclaimer
 * in the documentation and/or other materials provided with the
 * distribution.
 *     * Neither the name of Gregg Tavares. nor the names of his
 * contributors may be used to endorse or promote products derived from
 * this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

(function(e,t){if(typeof define=="function"&&define.amd)define([],t);else{var n=t.call(e);Object.keys(n).forEach(function(t){e[t]=n[t]})}})(this,function(){function t(t){e.console&&(e.console.error?e.console.error(t):e.console.log&&e.console.log(t))}function n(t){return t=t||e,t!==t.top}function r(e){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div>"+"</div>"+"</td></tr></table>"}function o(e,t){var n=["webgl","experimental-webgl"],r=null;for(var i=0;i<n.length;++i){try{r=e.getContext(n[i],t)}catch(s){}if(r)break}return r}function u(t,n){function u(e){var n=t.parentNode;n&&(n.innerHTML=r(e))}if(!e.WebGLRenderingContext)return u(i),null;var a=o(t,n);return a||u(s),a}function a(){n()&&(document.body.className="iframe")}function f(e,t,r){var i=r||{};if(n()){a();if(!i.dontResize&&i.resize!==!1){var s=e.clientWidth,o=e.clientHeight;e.width=s,e.height=o}}var f=u(e,t);return f}function l(e,n,r,i){var s=i||t,o=e.createShader(r);e.shaderSource(o,n),e.compileShader(o);var u=e.getShaderParameter(o,e.COMPILE_STATUS);if(!u){var a=e.getShaderInfoLog(o);return s("*** Error compiling shader '"+o+"':"+a),e.deleteShader(o),null}return o}function c(e,n,r,i,s){var o=s||t,u=e.createProgram();n.forEach(function(t){e.attachShader(u,t)}),r&&obj_attrib.forEach(function(t,n){e.bindAttribLocation(u,i?i[n]:n,t)}),e.linkProgram(u);var a=e.getProgramParameter(u,e.LINK_STATUS);if(!a){var f=e.getProgramInfoLog(u);return o("Error in program linking:"+f),e.deleteProgram(u),null}return u}function h(e,t,n,r){var i="",s,o=document.getElementById(t);if(!o)throw"*** Error: unknown script element"+t;i=o.text;if(!n)if(o.type==="x-shader/x-vertex")s=e.VERTEX_SHADER;else if(o.type==="x-shader/x-fragment")s=e.FRAGMENT_SHADER;else if(s!==e.VERTEX_SHADER&&s!==e.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return l(e,i,n?n:s,r)}function d(e,t,n,r,i){var s=[];for(var o=0;o<t.length;++o)s.push(h(e,t[o],e[p[o]],i));return c(e,s,n,r,i)}function v(e,t,n,r,i){var s=[];for(var o=0;o<t.length;++o)s.push(l(e,t[o],e[p[o]],i));return c(e,s,n,r,i)}function m(e,t){if(t===e.SAMPLER_2D)return e.TEXTURE_2D;if(t===e.SAMPLER_CUBE)return e.TEXTURE_CUBE_MAP}function g(e,t){function r(t,r){var i=e.getUniformLocation(t,r.name),s=r.type,o=r.size>1&&r.name.substr(-3)==="[0]";if(s===e.FLOAT&&o)return function(t){e.uniform1fv(i,t)};if(s===e.FLOAT)return function(t){e.uniform1f(i,t)};if(s===e.FLOAT_VEC2)return function(t){e.uniform2fv(i,t)};if(s===e.FLOAT_VEC3)return function(t){e.uniform3fv(i,t)};if(s===e.FLOAT_VEC4)return function(t){e.uniform4fv(i,t)};if(s===e.INT&&o)return function(t){e.uniform1iv(i,t)};if(s===e.INT)return function(t){e.uniform1i(i,t)};if(s===e.INT_VEC2)return function(t){e.uniform2iv(i,t)};if(s===e.INT_VEC3)return function(t){e.uniform3iv(i,t)};if(s===e.INT_VEC4)return function(t){e.uniform4iv(i,t)};if(s===e.BOOL)return function(t){e.uniform1iv(i,t)};if(s===e.BOOL_VEC2)return function(t){e.uniform2iv(i,t)};if(s===e.BOOL_VEC3)return function(t){e.uniform3iv(i,t)};if(s===e.BOOL_VEC4)return function(t){e.uniform4iv(i,t)};if(s===e.FLOAT_MAT2)return function(t){e.uniformMatrix2fv(i,!1,t)};if(s===e.FLOAT_MAT3)return function(t){e.uniformMatrix3fv(i,!1,t)};if(s===e.FLOAT_MAT4)return function(t){e.uniformMatrix4fv(i,!1,t)};if(s!==e.SAMPLER_2D&&s!==e.SAMPLER_CUBE||!o){if(s===e.SAMPLER_2D||s===e.SAMPLER_CUBE)return function(t,n){return function(r){e.uniform1i(i,n),e.activeTexture(e.TEXTURE0+n),e.bindTexture(t,r)}}(m(e,s),n++);throw"unknown type: 0x"+s.toString(16)}var u=[];for(var a=0;a<info.size;++a)u.push(n++);return function(t,n){return function(r){e.uniform1iv(i,n),r.forEach(function(r,i){e.activeTexture(e.TEXTURE0+n[i]),e.bindTexture(t,tetxure)})}}(m(e,s),u)}var n=0,i={},s=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(var o=0;o<s;++o){var u=e.getActiveUniform(t,o);if(!u)break;var a=u.name;a.substr(-3)==="[0]"&&(a=a.substr(0,a.length-3));var f=r(t,u);i[a]=f}return i}function y(e,t){Object.keys(t).forEach(function(n){var r=e[n];r&&r(t[n])})}function b(e,t){function r(t){return function(n){e.bindBuffer(e.ARRAY_BUFFER,n.buffer),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,n.numComponents||n.size,n.type||e.FLOAT,n.normalize||!1,n.stride||0,n.offset||0)}}var n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(var s=0;s<i;++s){var o=e.getActiveAttrib(t,s);if(!o)break;var u=e.getAttribLocation(t,o.name);n[o.name]=r(u)}return n}function w(e,t){Object.keys(t).forEach(function(n){var r=e[n];r&&r(t[n])})}function E(e,t,n,r,i){t=t.map(function(e){var t=document.getElementById(e);return t?t.text:e});var s=v(e,t,n,r,i);if(!s)return null;var o=g(e,s),u=b(e,s);return{program:s,uniformSetters:o,attribSetters:u}}function S(e,t,n){w(t,n.attribs),n.indices&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.indices)}function T(e,t){for(var n=0;n<x.length;++n){var r=x[n]+t,i=e.getExtension(r);if(i)return i}}function N(e){var t=e.clientWidth,n=e.clientHeight;return e.width!==t||e.height!==n?(e.width=t,e.height=n,!0):!1}function C(e){if(!n(e))return;var t=e.parent.document.getElementsByTagName("iframe");for(var r=0;r<t.length;++r){var i=t[r];if(i.contentDocument===e.document)return i}}function k(e){try{var t=C(e);if(!t)return!0;var n=t.getBoundingClientRect(),r=n.top<e.parent.innerHeight&&n.bottom>=0&&n.left<e.parent.innerWidth&&n.right>=0;return r&&k(e.parent)}catch(i){return!0}}function L(t){var n=!0;if(t){var r=t.getBoundingClientRect();n=r.top<e.innerHeight&&r.bottom>=0}return n&&k(e)}function A(e,t){var n=0;return e.push=function(){for(var t=0;t<arguments.length;++t){var r=arguments[t];if(r instanceof Array||r.buffer&&r.buffer instanceof ArrayBuffer)for(var i=0;i<r.length;++i)e[n++]=r[i];else e[n++]=r}},e.reset=function(e){n=e||0},e.numComponents=t,Object.defineProperty(e,"numElements",{get:function(){return this.length/this.numComponents|0}}),e}function O(e,t,n){var r=n||Float32Array;return A(new r(e*t),e)}function M(e,t,n,r){n=n||e.ARRAY_BUFFER;var i=e.createBuffer();return e.bindBuffer(n,i),e.bufferData(n,t,r||e.STATIC_DRAW),i}function _(e){return e!=="indices"}function D(e){var t={};return Object.keys(e).filter(_).forEach(function(e){t["a_"+e]=e}),t}function P(e,t){if(t instanceof Int8Array)return e.BYTE;if(t instanceof Uint8Array)return e.UNSIGNED_BYTE;if(t instanceof Int16Array)return e.SHORT;if(t instanceof Uint16Array)return e.UNSIGNED_SHORT;if(t instanceof Int32Array)return e.INT;if(t instanceof Uint32Array)return e.UNSIGNED_INT;if(t instanceof Float32Array)return e.FLOAT;throw"unsupported typed array type"}function H(e){return e instanceof Int8Array?!0:e instanceof Uint8Array?!0:!1}function B(e){return e.buffer&&e.buffer instanceof ArrayBuffer}function j(e,t){var n;e.indexOf("coord")>=0?n=2:e.indexOf("color")>=0?n=4:n=3;if(t%n>0)throw"can not guess numComponents. You should specify it.";return n}function F(e,t){if(B(e))return e;Array.isArray(e)&&(e={data:e}),e.numComponents||(e.numComponents=j(t,e.length));var n=e.type;n||t==="indices"&&(n=Uint16Array);var r=O(e.numComponents,e.data.length/e.numComponents|0,n);return r.push(e.data),r}function I(e,t,n){var r=n||D(t),i={};return Object.keys(r).forEach(function(n){var s=r[n],o=F(t[s],s);i[n]={buffer:M(e,o),numComponents:o.numComponents||j(s),type:P(e,o),normalize:H(o)}}),i}function q(e){var t=Object.keys(e)[0],n=e[t];return B(n)?n.numElements:n.data.length/n.numComponents}function R(e,t,n){var r={attribs:I(e,t,n)},i=t.indices;return i?(i=F(i,"indices"),r.indices=M(e,i,e.ELEMENT_ARRAY_BUFFER),r.numElements=i.length):r.numElements=q(t),r}function U(e,t){var n={};return Object.keys(t).forEach(function(r){var i=r==="indices"?e.ELEMENT_ARRAY_BUFFER:e.ARRAY_BUFFER,s=F(t[r],name);n[r]=M(e,s,i)}),t.indices?n.numElements=t.indices.length:t.position&&(n.numElements=t.position.length/3),n}function z(e,t,n,r,i){var s=n.indices,o=r===undefined?n.numElements:r;i=i===undefined?i:0,s?e.drawElements(t,o,e.UNSIGNED_SHORT,i):e.drawArrays(t,i,o)}function W(e,t){var n=null,r=null;t.forEach(function(t){var i=t.programInfo,s=t.bufferInfo,o=!1;i!==n&&(n=i,e.useProgram(i.program),o=!0);if(o||s!==r)r=s,S(e,i.attribSetters,s);y(i.uniformSetters,t.uniforms),z(e,e.TRIANGLES,s)})}var e=this,i='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',s='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',p=["VERTEX_SHADER","FRAGMENT_SHADER"],x=["","MOZ_","OP_","WEBKIT_"];return e.requestAnimationFrame&&(e.requestAnimationFrame=function(e){return function(t,n){var r=function(){L(n)?e(t,n):e(r,n)};r()}}(e.requestAnimationFrame)),e.requestAnimFrame=e.requestAnimationFrame,e.cancelRequestAnimFrame=e.cancelAnimationFrame,{createAugmentedTypedArray:O,createAttribsFromArrays:I,createBuffersFromArrays:U,createBufferInfoFromArrays:R,createAttributeSetters:b,createProgram:c,createProgramFromScripts:d,createProgramFromSources:v,createProgramInfo:E,createUniformSetters:g,drawBufferInfo:z,drawObjectList:W,getWebGLContext:f,updateCSSIfInIFrame:a,getExtensionWithKnownPrefixes:T,resizeCanvasToDisplaySize:N,setAttributes:w,setBuffersAndAttributes:S,setUniforms:y,setupWebGL:u}});